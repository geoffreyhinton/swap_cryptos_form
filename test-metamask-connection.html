<!DOCTYPE html>
<html>
<head>
    <title>MetaMask Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; }
    </style>
</head>
<body>
    <h1>üîß MetaMask Connection Diagnostic</h1>
    
    <button onclick="checkMetaMask()">1. Check MetaMask</button>
    <button onclick="connectAccount()">2. Connect Account</button>
    <button onclick="checkNetwork()">3. Check Network</button>
    <button onclick="checkBalance()">4. Check Balance</button>
    <button onclick="testRPC()">5. Test RPC Direct</button>
    
    <div id="results"></div>

    <script>
        function log(message, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        async function checkMetaMask() {
            document.getElementById('results').innerHTML = '';
            
            if (typeof window.ethereum !== 'undefined') {
                log('‚úÖ MetaMask is installed');
                log(`üîó Provider: ${window.ethereum.isMetaMask ? 'MetaMask' : 'Other'}`);
            } else {
                log('‚ùå MetaMask not found', true);
            }
        }

        async function connectAccount() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                log(`‚úÖ Connected account: ${accounts[0]}`);
                
                // Check if it's our test account
                if (accounts[0].toLowerCase() === '0x7e5f4552091a69125d5dfcb7b8c2659029395bdf') {
                    log('üéØ This is the correct test account!');
                } else {
                    log(`‚ö†Ô∏è This is a different account. Expected: 0x7E5F4552091A69125d5DfCb7b8C2659029395Bdf`, true);
                }
            } catch (error) {
                log(`‚ùå Failed to connect: ${error.message}`, true);
            }
        }

        async function checkNetwork() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                log(`üåê Current Chain ID: ${chainId} (${parseInt(chainId, 16)})`);
                
                if (parseInt(chainId, 16) === 1337) {
                    log('‚úÖ Connected to correct testnet (Chain ID 1337)');
                } else {
                    log('‚ùå Wrong network! Should be Chain ID 1337', true);
                }
            } catch (error) {
                log(`‚ùå Network check failed: ${error.message}`, true);
            }
        }

        async function checkBalance() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const balance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [accounts[0], 'latest']
                });
                
                const balanceInEth = parseInt(balance, 16) / Math.pow(10, 18);
                log(`üí∞ Account Balance: ${balanceInEth.toFixed(4)} ETH`);
                
                if (balanceInEth > 9999) {
                    log('üéâ SUCCESS! Balance shows 10,000 ETH');
                } else if (balanceInEth === 0) {
                    log('‚ùå Balance is 0 - there\'s a connection issue', true);
                } else {
                    log(`‚ö†Ô∏è Unexpected balance: ${balanceInEth} ETH`, true);
                }
            } catch (error) {
                log(`‚ùå Balance check failed: ${error.message}`, true);
            }
        }

        async function testRPC() {
            try {
                const response = await fetch('http://localhost:8545', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_getBalance',
                        params: ['0x7E5F4552091A69125d5DfCb7b8C2659029395Bdf', 'latest'],
                        id: 1
                    })
                });
                
                const data = await response.json();
                const balanceInEth = parseInt(data.result, 16) / Math.pow(10, 18);
                log(`üîÑ Direct RPC Balance: ${balanceInEth.toFixed(4)} ETH`);
                
                if (balanceInEth > 9999) {
                    log('‚úÖ Direct RPC connection works perfectly');
                    log('üîç The issue is MetaMask not connecting to your local RPC');
                }
            } catch (error) {
                log(`‚ùå Direct RPC failed: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>